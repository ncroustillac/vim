#! /bin/sh
#--------------------------------------------------------------------------------
# This script allows to activate/deactivate the WIFI
#--------------------------------------------------------------------------------
LISTEN_DIR="/containers/container-as/var/services/wifi/input"
TRIGGER_ENABLE_FILE="${LISTEN_DIR}/.trigger_enable"
TRIGGER_DISABLE_FILE="${LISTEN_DIR}/.trigger_disable"

#--------------------------------------------------------------------------------
# FUNCTIONS
#--------------------------------------------------------------------------------
f_configure_wifi(){
    # first enable device by setting enable pins
    hv3gpio -w on

    # then insert laird module
    if [[ "$(lsmod)" != *"brcmfmac"* ]]; then
        sleep 0.2   # few time for the device to boot
        modprobe brcmfmac
    fi
}

f_disable_wifi(){
    hv3gpio -w off
}

#--------------------------------------------------------------------------------
# MAIN
#--------------------------------------------------------------------------------
# check requested actions
for entry in ${LISTEN_DIR}/.*
do
    case ${entry} in
        ${TRIGGER_ENABLE_FILE})
          f_configure_wifi
          rm ${TRIGGER_ENABLE_FILE}
          ;;
        ${TRIGGER_DISABLE_FILE})
          f_disable_wifi
          rm ${TRIGGER_DISABLE_FILE}
          ;;
        *)
          ;;
    esac
done

